
var QTIWidgetFactory=function(options){var _this=this;this.opts=options;this.qti_item_id="#"+this.opts["id"];this.wwwPath='';if(typeof(qti_base_www)!='undefined'){this.wwwPath=qti_base_www;if(!/\/$/.test(this.wwwPath)&&this.wwwPath!=''){this.wwwPath+='/';}}
this.graphicDebug=false;if(typeof(qti_debug)!='undefined'){this.graphicDebug=qti_debug;}
this.build=function(typeName){if(typeof(qti_debug)!='undefined'){if(!QTIWidget[typeName]){alert("Error: Unknow widget "+typeName);}}
QTIWidget[typeName](_this);};};function pointerPolyCoordonates(path){var pathArray=new Array();pathArray=path.split(",");return[pathArray[0],pathArray[1]];}
function polyCoordonates(path){var pathArray=new Array();pathArray=path.split(",");var pathArrayLength=pathArray.length;if((pathArray[0]!=pathArray[pathArrayLength-2])&&(pathArray[1]!=pathArray[pathArrayLength-1])){pathArray.push(pathArray[0]);pathArray.push(pathArray[1]);}
pathArray[0]="M"+pathArray[0];for(var a=1;a<pathArrayLength;a++){if(isPair(a)){pathArray[a]="L"+pathArray[a];}}
return pathArray.join(" ");}
function isPair(number){return((number-1)%2);}
var QTIWidget=QTIWidget||{};QTIWidget.associate=function(ctx){$(ctx.qti_item_id+" .qti_choice_list li").wrapInner("<div></div>");var maxBoxSize=0;$(ctx.qti_item_id+" ul.qti_choice_list li > div").each(function(){if($(this).width()>maxBoxSize){maxBoxSize=$(this).width();}});var listHeight=parseInt($(ctx.qti_item_id+" .qti_associate_container").height());var liMaxHeight=0;$(ctx.qti_item_id+" .qti_choice_list li > div").each(function(){var liHeight=parseInt($(this).height());if(liHeight>liMaxHeight){liMaxHeight=liHeight;}
if(liHeight>listHeight){listHeight=liHeight+10;}});$(ctx.qti_item_id+" .qti_associate_container .qti_choice_list").height(listHeight+10);if(ctx.opts["maxAssociations"]>0){var pairSize=ctx.opts["maxAssociations"];}
else{var pairSize=parseInt($(ctx.qti_item_id+" .qti_choice_list li").length/2);}
var pairContainer=$("<div class='qti_pair_container'></div>");for(var a=1;a<=pairSize;a++){var currentPairName=ctx.opts["id"]+"_"+a;pairContainer.append("<ul class='qti_association_pair' id='"+currentPairName+"'><li id='"+currentPairName+"_A"+"'></li><li id='"+currentPairName+"_B"+"'></li></ul>");}
$(ctx.qti_item_id+" .qti_associate_container").after(pairContainer);$(ctx.qti_item_id+" .qti_association_pair li").width(maxBoxSize+4);var pairBoxWidth=0;$(ctx.qti_item_id+" .qti_association_pair:first li").each(function(){pairBoxWidth+=$(this).width();});$(ctx.qti_item_id+" .qti_pair_container").css({position:"relative",width:((pairBoxWidth+20)*2)+30,margin:"0 auto 0 auto",top:"10px"});$(ctx.qti_item_id+" .qti_association_pair").width(pairBoxWidth+90);$(ctx.qti_item_id+" .qti_association_pair li").height(liMaxHeight);$.each($(ctx.qti_item_id+" .qti_association_pair"),function(index,elt){$(elt).after("<div class='qti_link_associate'></div>");$(ctx.qti_item_id+" .qti_link_associate:last").css("top",$(this).position().top+25);$(ctx.qti_item_id+" .qti_link_associate:last").css("left",maxBoxSize+33);});$(ctx.qti_item_id).height(($(ctx.qti_item_id+" .qti_association_pair:last").offset().top-$(ctx.qti_item_id).offset().top)+liMaxHeight);$(ctx.qti_item_id+" .qti_associate_container .qti_choice_list li > div").draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");},containment:ctx.qti_item_id,cursor:"move",revert:true});var removeFilledPair=function(jElement){var filledId=jElement.attr("id").replace('pair_','');var _matchMax=Number(ctx.opts["matchMaxes"][filledId]["matchMax"]);var _current=Number(ctx.opts["matchMaxes"][filledId]["current"]);if(_current>0){ctx.opts["matchMaxes"][filledId]["current"]=_current-1;}
jElement.parents('li').removeClass('ui-state-highlight');jElement.remove();if(_current>=_matchMax){$("#"+filledId+" div").show();}};var fillPair=function(jDropped,jDragged){jDropped.addClass('ui-state-highlight');var draggedId=jDragged.parents().attr('id');jDropped.html("<div id='pair_"+draggedId+"' class='filled_pair'>"+jDragged.html()+"</div>");$(ctx.qti_item_id+" #pair_"+draggedId).width($(ctx.qti_item_id+" .qti_association_pair li").width());$(ctx.qti_item_id+" #pair_"+draggedId).height($(ctx.qti_item_id+" .qti_association_pair li").height());var _matchMax=Number(ctx.opts["matchMaxes"][draggedId]["matchMax"]);var _current=Number(ctx.opts["matchMaxes"][draggedId]["current"]);if(_current<_matchMax){_current++;ctx.opts["matchMaxes"][draggedId]["current"]=_current;}
if(_current>=_matchMax&&_matchMax>0){jDragged.hide();}
$(ctx.qti_item_id+" #pair_"+draggedId).draggable({drag:function(event,ui){$(this).css("z-index","999");},stop:function(event,ui){removeFilledPair($(this));return true;},containment:ctx.qti_item_id,cursor:"move"});};$(ctx.qti_item_id+" .qti_association_pair li").droppable({drop:function(event,ui){var draggedId=$(ui.draggable).parents().attr('id');if($(this).find("#pair_"+draggedId).length>0||/^pair_/.test($(ui.draggable).attr('id'))){return false;}
var _matchGroup=ctx.opts["matchMaxes"][draggedId]["matchGroup"];if(/A$/.test($(this).attr('id'))){var opposite=$('#'+$(this).attr('id').replace(/_A$/,"_B")).find('.filled_pair:first');}
else{var opposite=$('#'+$(this).attr('id').replace(/_B$/,"_A")).find('.filled_pair:first');}
if(opposite.length>0){var oppositeId=opposite.attr('id').replace('pair_','');if(_matchGroup.length>0){if($.inArray(oppositeId,_matchGroup)<0){$(this).effect("highlight",{color:'#B02222'},1000);return false;}}
var _oppositeMatchGroup=ctx.opts["matchMaxes"][oppositeId]["matchGroup"];if(_oppositeMatchGroup.length>0){if($.inArray(draggedId,_oppositeMatchGroup)<0){$(this).effect("highlight",{color:'#B02222'},1000);return false;}}}
if($(this).html()!=''){$('.filled_pair',$(this)).each(function(){removeFilledPair($(this));});}
$(ui.helper).css({top:"0",left:"0"});fillPair($(this),$(ui.draggable));},hoverClass:'active'});if(ctx.opts["values"]){var index=1;var values=ctx.opts["values"];if(typeof(values)=='object'){for(i in values){var pair=values[i];if(pair.length==2){var valA=pair[0];if(typeof(valA)=='string'&&valA!=''){if($(ctx.qti_item_id+" li#"+valA).length==1){fillPair($(ctx.qti_item_id+"_"+index+"_A"),$(ctx.qti_item_id+" .qti_associate_container .qti_choice_list li#"+valA+" > div"));}}
var valB=pair[1];if(typeof(valB)=='string'&&valB!=''){if($(ctx.qti_item_id+" li#"+valB).length==1){fillPair($(ctx.qti_item_id+"_"+index+"_B"),$(ctx.qti_item_id+" .qti_associate_container .qti_choice_list li#"+valB+" > div"));}}
index++;}}}}};QTIWidget.graphic_associate=function(ctx){var countChoices=ctx.opts["maxAssociations"];var pointsPair=new Array();var imageHeight=parseInt(ctx.opts.imageHeight);var imageWidth=parseInt(ctx.opts.imageWidth);$(ctx.qti_item_id+" .qti_graphic_associate_spotlist li").css("display","none");var itemHeight=parseInt($(ctx.qti_item_id).height());$(ctx.qti_item_id).css("height",itemHeight+imageHeight);if(isNaN(imageHeight)||isNaN(imageWidth)){$(ctx.qti_item_id).append("<div class='img-loader' style='visibility:hidden;'></div>");$loadedImg=$("<img src='"+ctx.opts.imagePath+"' />");$loadedImg.load(function(){var imageWidth=parseInt($(this).width());var imageHeight=parseInt($(this).height());$(ctx.qti_item_id+' .img-loader').remove();createArea(imageWidth,imageHeight);});$(ctx.qti_item_id+' .img-loader').append($loadedImg);}
else{createArea(imageWidth,imageHeight);}
function createArea(imageWidth,imageHeight){$(ctx.qti_item_id).prepend("<div class='svg-container'></div>");var paper=Raphael($(ctx.qti_item_id+' .svg-container')[0],imageWidth,imageHeight);paper.image(ctx.opts.imagePath,0,0,imageWidth,imageHeight);var model_obj=new Object();var line_ref_obj=new Object();if(ctx.opts["maxAssociations"]>0){$(ctx.qti_item_id+" .link_counter").text(ctx.opts["maxAssociations"]);}else{$(ctx.qti_item_id+" .link_counter").html("<span class='infiniteSize'>∞</span>");}
var deleteButton=paper.image(ctx.wwwPath+"img/delete.png",0,0,14,14);deleteButton.attr("opacity","0");$(ctx.qti_item_id+" .qti_graphic_associate_spotlist li").each(function(){var currentHotSpotShape=ctx.opts.graphicAssociateChoices[$(this).attr("id")]["shape"];var currentHotSpotCoords=ctx.opts.graphicAssociateChoices[$(this).attr("id")]["coords"].split(",");var currentHotSpotX,currentHotSpotY,currentHotSpotSize,currentHotSpotTopX,currentHotSpotTopY;var currentHotSpotBottomX,currentHotSpotBottomY,currentHotSpotHradius,currentHotSpotVradius;var pointerSize=5,pointer,pointerCoordonates;var polyCoords;var currentShape;var shapeWidth,shapeHeight;switch(currentHotSpotShape){case"circle":currentHotSpotX=Number(currentHotSpotCoords[0]);currentHotSpotY=Number(currentHotSpotCoords[1]);currentHotSpotSize=currentHotSpotCoords[2];currentShape=paper[currentHotSpotShape](currentHotSpotX,currentHotSpotY,currentHotSpotSize);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");pointer=paper.circle(currentHotSpotX,currentHotSpotY,pointerSize);break;case"rect":currentHotSpotTopX=Number(currentHotSpotCoords[0]);currentHotSpotTopY=Number(currentHotSpotCoords[1]);currentHotSpotBottomX=currentHotSpotCoords[2]-currentHotSpotTopX;currentHotSpotBottomY=currentHotSpotCoords[3]-currentHotSpotTopY;currentShape=paper[currentHotSpotShape](currentHotSpotTopX,currentHotSpotTopY,currentHotSpotBottomX,currentHotSpotBottomY);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");shapeWidth=currentShape.getBBox().width;shapeHeight=currentShape.getBBox().height;pointer=paper.circle(currentHotSpotTopX+(shapeWidth/2),currentHotSpotTopY+(shapeHeight/2),pointerSize);break;case"ellipse":currentHotSpotX=Number(currentHotSpotCoords[0]);currentHotSpotY=Number(currentHotSpotCoords[1]);currentHotSpotHradius=currentHotSpotCoords[2];currentHotSpotVradius=currentHotSpotCoords[3];currentShape=paper[currentHotSpotShape](currentHotSpotX,currentHotSpotY,currentHotSpotHradius,currentHotSpotVradius);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");pointer=paper.circle(currentHotSpotX,currentHotSpotY,pointerSize);break;case"poly":polyCoords=polyCoordonates(ctx.opts.graphicAssociateChoices[$(this).attr("id")]["coords"]);currentShape=paper["path"](polyCoords);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");shapeWidth=currentShape.getBBox().width;shapeHeight=currentShape.getBBox().height;pointerCoordonates=pointerPolyCoordonates(ctx.opts.graphicAssociateChoices[$(this).attr("id")]["coords"]);currentHotSpotTopX=Number(pointerCoordonates[0]);currentHotSpotTopY=Number(pointerCoordonates[1]);pointer=paper.circle(currentHotSpotTopX+(shapeWidth/2),currentHotSpotTopY+(shapeHeight/2),pointerSize);break;}
var maxSubLink=ctx.opts.graphicAssociateChoices[$(this).attr("id")]["matchMax"];model_obj[$(this).attr("id")]={pointer:pointer,ref:currentShape,pointerState:"hidden",linkRelation:{},maxSubLinkLength:maxSubLink};pointer.attr("fill","black");pointer.attr("opacity","0");currentShape.toFront();currentShape.attr("fill","pink");currentShape.attr("fill-opacity","0");currentShape.attr("stroke-opacity","0");if(ctx.graphicDebug)currentShape.attr("stroke-opacity","1");currentShape.attr("stroke","blue");ctx.opts[currentShape.node]=$(this).attr("id");$(currentShape.node).bind("mousedown",{zis:currentShape,name:$(this).attr("id"),pair:pointsPair,zepointer:pointer},function(e){for(var i in line_ref_obj){line_ref_obj[i].attr("stroke","black").attr('stroke-width','3');}
$(deleteButton.node).unbind("mousedown");var pointer=e.data.zepointer;deleteButton.attr("opacity","0");pointer.attr("fill","red");pointer.attr("stroke","white");if(e.data.pair.length<1){e.data.pair.push(e.data.name);var currentLinkLength=displayedSubLink(model_obj[e.data.name].linkRelation);var maxLinkAvalaible=model_obj[e.data.name].maxSubLinkLength-currentLinkLength;if(model_obj[e.data.name].maxSubLinkLength<1){$(ctx.qti_item_id+" .sub_counter").html("<span class='infiniteSize'>∞</span>");}
else{$(ctx.qti_item_id+" .sub_counter").text(maxLinkAvalaible);}}
else{e.data.pair.push(e.data.name);var startId=e.data.pair[0];var endId=e.data.pair[1];var startPointer=model_obj[e.data.pair[0]].pointer;var endPointer=model_obj[e.data.pair[1]].pointer;var relation=e.data.pair[0]+' '+e.data.pair[1];var targetRelation=e.data.pair[1]+' '+e.data.pair[0];if(startPointer==endPointer){startPointer.attr("fill","black");startPointer.attr("stroke","black");endPointer.attr("fill","black");endPointer.attr("stroke","black");hideSinglePoint(model_obj,e.data.pair[0],e.data.pair[1],startPointer,endPointer);emptyArray(e.data.pair);$(ctx.qti_item_id+" .sub_counter").text("");startPointer.attr("opacity","0");return;}
if(countChoices==0&&ctx.opts["maxAssociations"]!=0){startPointer.attr("fill","black");startPointer.attr("stroke","black");endPointer.attr("fill","black");endPointer.attr("stroke","black");hideSinglePoint(model_obj,e.data.pair[0],e.data.pair[1],startPointer,endPointer);emptyArray(e.data.pair);return;}
var subLinkLength=displayedSubLink(model_obj[e.data.pair[0]].linkRelation);var targetSubLinkLength=displayedSubLink(model_obj[e.data.pair[1]].linkRelation);if(model_obj[e.data.pair[0]].maxSubLinkLength==0){if((targetSubLinkLength+1)>model_obj[e.data.pair[1]].maxSubLinkLength&&model_obj[e.data.pair[1]].maxSubLinkLength!=0){startPointer.attr("fill","black");startPointer.attr("stroke","black");endPointer.attr("fill","black");endPointer.attr("stroke","black");hideSinglePoint(model_obj,e.data.pair[0],e.data.pair[1],startPointer,endPointer);emptyArray(e.data.pair);return;}}else
if(subLinkLength>=model_obj[e.data.pair[0]].maxSubLinkLength||(targetSubLinkLength+1)>model_obj[e.data.pair[1]].maxSubLinkLength){if(model_obj[e.data.pair[1]].maxSubLinkLength!=0){startPointer.attr("fill","black");startPointer.attr("stroke","black");endPointer.attr("fill","black");endPointer.attr("stroke","black");hideSinglePoint(model_obj,e.data.pair[0],e.data.pair[1],startPointer,endPointer);emptyArray(e.data.pair);return;}}
if(model_obj[e.data.pair[0]].linkRelation[relation]!=undefined){emptyArray(e.data.pair);return;}
var startPointX=startPointer.getBBox().x+startPointer.getBBox().width/2;var startPointY=startPointer.getBBox().y+startPointer.getBBox().width/2;var endPointX=endPointer.getBBox().x+endPointer.getBBox().width/2;var endPointY=endPointer.getBBox().y+endPointer.getBBox().width/2;var drawingPath="M"+startPointX+" "+startPointY+"L"+endPointX+" "+endPointY;var line=paper.path(drawingPath);line.attr('stroke-width','3');startPointer.attr("fill","black");startPointer.attr("stroke","black");endPointer.attr("fill","black");endPointer.attr("stroke","black");model_obj[startId].linkRelation[relation]={};model_obj[startId].linkRelation[relation].lineRef=line;model_obj[startId].linkRelation[relation].endRef=endPointer;model_obj[endId].linkRelation[targetRelation]={};model_obj[endId].linkRelation[targetRelation].lineRef=line;model_obj[endId].linkRelation[targetRelation].endRef=startPointer;line_ref_obj[relation]=line;var pairs=[];for(aPair in line_ref_obj){pairs.push(aPair);}
$(ctx.qti_item_id).data('pairs',pairs);emptyArray(e.data.pair);var pairOfPoints=e.data.pair;$(line.node).bind("mousedown",{zeline:line,centerX:(startPointX+endPointX)/2,centerY:(startPointY+endPointY)/2,zerelation:relation},function(e){var localRelation=e.data.zerelation;var localLine=e.data.zeline;for(var i in line_ref_obj){line_ref_obj[i].attr("stroke","black");}
deleteButton.attr("opacity","1");deleteButton.attr("x",e.data.centerX-7);deleteButton.attr("y",e.data.centerY-7);deleteButton.toFront();$(deleteButton.node).unbind("mousedown").bind("mousedown",{zisbutton:deleteButton},function(e){e.preventDefault();delete model_obj[startId].linkRelation[localRelation];delete model_obj[endId].linkRelation[targetRelation];localLine.remove();e.data.zisbutton.attr("opacity","0");if(ctx.opts["maxAssociations"]>0&&countChoices<ctx.opts["maxAssociations"]){countChoices++;$(ctx.qti_item_id+" .link_counter").text(countChoices);}
hideSinglePoint(model_obj,startId,endId,startPointer,endPointer);delete line_ref_obj[localRelation];emptyArray(pairOfPoints);var pairs=[];for(aPair in line_ref_obj){pairs.push(aPair);}
$(ctx.qti_item_id).data('pairs',pairs);$(this).unbind("mousedown");});var line=e.data.zeline;line.attr("stroke","red");});if(ctx.opts["maxAssociations"]>0){countChoices--;$(ctx.qti_item_id+" .link_counter").text(countChoices);}
e.data.zis.toFront();}
model_obj[e.data.name].pointer.attr("opacity","1");model_obj[e.data.name].pointerState="show";for(var t in model_obj){model_obj[t].ref.toFront();}});});}
if(ctx.opts["values"]){var values=ctx.opts["values"];if(typeof(values)=='object'){for(index in values){var value=values[index];if(typeof(value)=='object'){if(value.length==2){var startShape=model_obj[value[0]]['ref'];if(startShape){$(startShape.node).trigger("mousedown",{zis:startShape,name:value[0],pair:pointsPair,zepointer:model_obj[value[0]]['pointer']});var endShape=model_obj[value[1]]['ref'];if(endShape){$(endShape.node).trigger("mousedown",{zis:endShape,name:value[1],pair:pointsPair,zepointer:model_obj[value[1]]['pointer']});}}}}}}}
function hideSinglePoint(obj,startId,endId,startPointer,endPointer){var rela=0;for(var z in obj[startId].linkRelation){rela++;}
var relb=0;for(var e in obj[endId].linkRelation){relb++;}
if(rela<1)startPointer.attr("opacity","0");if(relb<1)endPointer.attr("opacity","0");}
function emptyArray(aRay){while(aRay.length>0){aRay.pop();}}
function displayedLink(objai){var xx=0;for(var a in objai){if(displayedSubLink(objai[a].linkRelation)>0)xx++;}
return xx;}
function displayedSubLink(objai){var i=0;for(var a in objai){i++;}
return i;}};
var QTIWidget=QTIWidget||{};QTIWidget.slider=function(ctx){$(ctx.qti_item_id).append("<input type='hidden' id='qti_slider_value' />").append("<div class='qti_slider'></div>").append("<div class='qti_slider_label'></div>");var containerWidth=parseInt($(ctx.qti_item_id).width());var min=parseInt(ctx.opts['lowerBound']);var max=parseInt(ctx.opts['upperBound']);var step=parseInt(ctx.opts['step']);var stepLabel=(ctx.opts['stepLabel']===true);var reverse=(ctx.opts['reverse']===true);var orientation='horizontal';if($.inArray(ctx.opts['orientation'],['horizontal','vertical'])>-1){orientation=ctx.opts['orientation'];}
var sliderSize=((max-min)/step)*20;if(orientation=='horizontal'){if(sliderSize>containerWidth){sliderSize=containerWidth-20;}
$(ctx.qti_item_id).addClass('qti_slider_horizontal');$(ctx.qti_item_id+' .qti_slider').width(sliderSize+'px');$(ctx.qti_item_id+' .qti_slider_label').width((sliderSize+40)+'px');}
else{var maxHeight=300;if(sliderSize>maxHeight){sliderSize=maxHeight;}
$(ctx.qti_item_id).addClass('qti_slider_vertical');$(ctx.qti_item_id+' .qti_slider').height(sliderSize+'px');$(ctx.qti_item_id+' .qti_slider_label').height((sliderSize+20)+'px');}
if(!stepLabel){var displayMin=min;var displayMax=max;if(reverse){displayMin=max;displayMax=min;}
$(ctx.qti_item_id+' .qti_slider_label').append("<span class='slider_min'>"+displayMin+"</span>").append("<span class='slider_max'>"+displayMax+"</span>");}
else{var stepSpacing=20;var displayRatio=1;if((max*20)>sliderSize){do{stepSpacing=(sliderSize/(max/displayRatio));displayRatio++;}while(stepSpacing<25);displayRatio--;}
var i=0;for(i=min;i<=max;i+=(step*displayRatio)){var displayIndex=i;if(reverse){displayIndex=max-i;}
var $iStep=$("<span>"+displayIndex+"</span>");if(orientation=='horizontal'){$iStep.css({left:((i/displayRatio)*stepSpacing)+'px'});}
else{$iStep.css({top:((i/displayRatio)*stepSpacing)+'px'});}
$(ctx.qti_item_id+' .qti_slider_label').append($iStep);}
if(i!=max){if(i<max){$(ctx.qti_item_id+' .qti_slider_label span:last').remove();}
var displayMax=max;if(reverse){displayMax=min;}
var $iStep=$("<span>"+displayMax+"</span>");if(orientation=='horizontal'){$iStep.css({right:'0px'});}
else{$iStep.css({bottom:'0px'});}
$(ctx.qti_item_id+' .qti_slider_label').append($iStep);}}
var $sliderVal=$("#qti_slider_value");var val=min;if((reverse&&orientation=='horizontal')||(!reverse&&orientation=='vertical')){val=max;}
if(ctx.opts["values"]){if(typeof(ctx.opts["values"])=='string'&&ctx.opts["values"]!=''){val=ctx.opts["values"];}}
$(ctx.qti_item_id+' .qti_slider').slider({value:val,min:min,max:max,step:step,orientation:orientation,slide:function(event,ui){var val=ui.value;if((reverse&&orientation=='horizontal')||(!reverse&&orientation=='vertical')){val=max-ui.value;}
$sliderVal.val(val);}});$sliderVal.val(val);};QTIWidget.upload=function(ctx){var uploaderElt=$(ctx.qti_item_id+'_uploader');if(uploaderElt.length>0){var fileExt='*';if(ctx.opts['ext']){if(ctx.opts['ext']!=''){fileExt='*.'+ctx.opts['ext'];}}
var uploadOptions={"scriptData":{'session_id':ctx.opts['session_id']},"basePath":ctx.wwwPath,"rootUrl":'',"fileDesc":'Allowed files type: '+fileExt,"fileExt":fileExt,"target":ctx.qti_item_id+'_data',"folder":"/"};new AsyncFileUpload(uploaderElt.attr('id'),uploadOptions);}};QTIWidget.end_attempt=function(ctx){$(ctx.qti_item_id).val(ctx.opts['title']);$(ctx.qti_item_id).click(function(){$(ctx.qti_item_id+'_data').val(1);$("#qti_validate").click();});}
var QTIWidget=QTIWidget||{};QTIWidget.choice=function(ctx){var maxChoices=parseInt(ctx.opts["maxChoices"]);if(maxChoices>1||maxChoices==0){QTIWidget.multiple_choice(ctx);}
else{QTIWidget.simple_choice(ctx);}};QTIWidget.simple_choice=function(ctx){$(ctx.qti_item_id).addClass('qti_simple_interaction');$(ctx.qti_item_id+" ul li").bind("click",function(){$(ctx.qti_item_id+" ul li").removeClass("tabActive");$(this).addClass("tabActive");});if(ctx.opts["values"]){var value=ctx.opts["values"];if(typeof(value)=='string'&&value!=''){$(ctx.qti_item_id+" ul li#"+value).addClass("tabActive");}}};QTIWidget.multiple_choice=function(ctx){$(ctx.qti_item_id).addClass('qti_multi_interaction');$(ctx.qti_item_id+" ul li").bind("click",function(){if($(this).hasClass("tabActive")){$(this).removeClass("tabActive");}
else{if($(ctx.qti_item_id+" ul li.tabActive").length<ctx.opts["maxChoices"]||ctx.opts["maxChoices"]==0){$(this).addClass("tabActive");}}});if(ctx.opts["values"]){var values=ctx.opts["values"];if(typeof(values)=='object'){for(i in values){var value=values[i];if(typeof(value)=='string'&&value!=''){$(ctx.qti_item_id+" ul li#"+value).addClass("tabActive");}}}}};QTIWidget.inline_choice=function(ctx){if(ctx.opts["values"]){var value=ctx.opts["values"];if(typeof(value)=='string'&&value!=''){$(ctx.qti_item_id+" option[value='"+value+"']").attr('selected',true);}}};
var QTIWidget=QTIWidget||{};QTIWidget.gap_match=function(ctx){$(ctx.qti_item_id+" .qti_choice_list").wrap("<div class='qti_gap_match_container'></div>");$(ctx.qti_item_id+" .qti_choice_list li").wrapInner("<div></div>");$(ctx.qti_item_id+" .qti_choice_list li:last").after("<li><div></div></li>");$(ctx.qti_item_id+" .qti_choice_list li:last").css('clear','both');$(ctx.qti_item_id+" .qti_choice_list").height(parseFloat($(".qti_gap_match_container").height()));var maxBoxSize=0;$(ctx.qti_item_id+" ul.qti_choice_list li > div").each(function(){if($(this).width()>maxBoxSize){maxBoxSize=$(this).width();}});maxBoxSize=((parseInt(maxBoxSize)/2)+5)+'px';$(ctx.qti_item_id+" .gap").css({"padding-left":maxBoxSize,"padding-right":maxBoxSize});$(ctx.qti_item_id+" .qti_gap_match_container .qti_choice_list li > div").draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");},containment:ctx.qti_item_id,revert:true,cursor:"move"});$(ctx.qti_item_id+" .gap").html('&nbsp;');var fillGap=function(jDropped,jDragged){var draggedId=jDragged.parent().attr("id");var _matchMax=Number(ctx.opts["matchMaxes"][draggedId]["matchMax"]);var _current=Number(ctx.opts["matchMaxes"][draggedId]["current"]);jDropped.css({'padding-left':'5px','padding-right':'5px'}).addClass('dropped_gap');jDropped.html("<span id='gap_"+draggedId+"' class='filled_gap'>"+jDragged.text()+"</span>");if(_current<_matchMax){_current++;ctx.opts["matchMaxes"][draggedId]["current"]=_current;}
if(_current>=_matchMax){jDragged.hide();}
$(ctx.qti_item_id+" .filled_gap").draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");$(this).parent().addClass('ui-state-highlight');},stop:function(){$(this).parent().removeClass('ui-state-highlight');removeFilledGap($(this));},revert:false,containment:ctx.qti_item_id,cursor:"move"});};var removeFilledGap=function(jElement){var filledId=jElement.attr("id").replace('gap_','');var _matchMax=Number(ctx.opts["matchMaxes"][filledId]["matchMax"]);var _current=Number(ctx.opts["matchMaxes"][filledId]["current"]);if(_current>0){ctx.opts["matchMaxes"][filledId]["current"]=_current-1;}
jElement.parent().css({"padding-left":maxBoxSize,"padding-right":maxBoxSize}).removeClass('dropped_gap').html('&nbsp;');jElement.remove();if(_current>=_matchMax){$("#"+filledId+" div").show();}};$(ctx.qti_item_id+" .gap").droppable({drop:function(event,ui){var draggedId=$(ui.draggable).parent().attr("id");if($(this).find("#gap_"+draggedId).length>0||/^gap_/.test($(ui.draggable).attr('id'))){return false;}
var _matchGroup=ctx.opts["matchMaxes"][draggedId]["matchGroup"];if(_matchGroup.length>0){if($.inArray($(this).attr('id'),_matchGroup)<0){$(this).effect("highlight",{color:'#B02222'},1000);return false;}}
var _gapMatchGroup=ctx.opts["matchMaxes"][$(this).attr('id')]["matchGroup"];if(_gapMatchGroup.length>0){if($.inArray(draggedId,_gapMatchGroup)<0){$(this).effect("highlight",{color:'#B02222'},1000);return false;}}
if($(this).html()!=''){$('.filled_gap',$(this)).each(function(){removeFilledGap($(this));});}
fillGap($(this),$(ui.draggable));},hoverClass:'active'});if(ctx.opts["values"]){var values=ctx.opts["values"];if(typeof(values)=='object'){for(i in values){var value=values[i];if(value['0']&&value['1']){var gap=value['0'];var choice=value['1'];fillGap($(ctx.qti_item_id+" .gap#"+gap),$(ctx.qti_item_id+" .qti_choice_list li#"+choice+" > div"));}}}}};QTIWidget.match=function(ctx){$(ctx.qti_item_id+" .choice_list:last").addClass('choice_list_cols');var cols=new Array();$(ctx.qti_item_id+" .choice_list_cols li").each(function(){cols.push(this.id);});$(ctx.qti_item_id+" .choice_list:first").addClass('choice_list_rows');var rows=new Array();$(ctx.qti_item_id+" .choice_list_rows li").each(function(){rows.push(this.id);});$(ctx.qti_item_id+" .choice_list_cols").after("<div class='match_node_container'></div>");$(ctx.qti_item_id+" .match_node_container").height(parseInt($(ctx.qti_item_id+" .choice_list_rows").height()));$(ctx.qti_item_id+" .match_node_container").css({'left':$(ctx.qti_item_id+" .choice_list_rows").width()});var maxHeight=25;$(ctx.qti_item_id+" .choice_list_cols li").each(function(){var height=parseInt($(this).height());if(height>maxHeight){maxHeight=height;}});$(ctx.qti_item_id+" .choice_list_cols li").each(function(){var li=$(this);li.css('width',li.width());var myDiv=$("<div />").css({'width':li.width(),'height':maxHeight+'px','border':li.css('border')});li.css('height','25px');$(this).wrapInner(myDiv);});$(ctx.qti_item_id+" .prompt").css('margin-bottom',(maxHeight-20)+'px');var i=0;var currentHeight=0;while(i<rows.length){var xnode='xnode_'+rows[i];var rowHeight=parseFloat($("#"+rows[i]).height());var j=0;while(j<cols.length){var ynode='ynode_'+cols[j];var node_id='match_node_'+i+'_'+j;$(ctx.qti_item_id+" .match_node_container").append("<div id='"+node_id+"' class='match_node "+xnode+" "+ynode+"'>&nbsp;</div>");left=0;if(j>0){p=$("#"+'match_node_'+i+'_'+(j-1)).position();left=parseInt(p.left)+parseInt($("#"+'match_node_'+i+'_'+(j-1)).width())+(12);}
var colWidth=parseFloat($("#"+cols[j]).width());$(ctx.qti_item_id+" #"+node_id).css({'top':((currentHeight)+(i*2))+'px','left':left+'px','width':colWidth+'px','height':rowHeight+'px'});j++;}
currentHeight+=rowHeight;i++;}
function getNodeXY(jElement){var x=null;var y=null;var classes=jElement.attr('class').split(' ');for(i in classes){if(/^xnode_/.test(classes[i])){x={'id':classes[i].replace('xnode_',''),'class':classes[i]};}
else if(/^ynode_/.test(classes[i])){y={'id':classes[i].replace('ynode_',''),'class':classes[i]};}
if(x!=null&&y!=null){break;}}
return{xnode:x,ynode:y};}
function deactivateNode(jElement){jElement.removeClass('tabActive');for(var i=0;i<associations.length;i++){if(associations[i]==jElement.attr('id')){associations.splice(i,1);}}}
var maxAssociations=ctx.opts['maxAssociations'];var associations=new Array();var selectNode=function(jElement){if(jElement.hasClass('tabActive')){deactivateNode(jElement);}
else{if(associations.length<maxAssociations||maxAssociations==0){var nodeXY=getNodeXY(jElement);var _rowMatchGroup=ctx.opts["matchMaxes"][nodeXY.xnode.id]['matchGroup'];if(_rowMatchGroup.length>0){if($.inArray(nodeXY.ynode.id,_rowMatchGroup)<0){jElement.effect("highlight",{color:'#B02222'},1000);return false;}}
var _colMatchGroup=ctx.opts["matchMaxes"][nodeXY.ynode.id]['matchGroup'];if(_colMatchGroup.length>0){if($.inArray(nodeXY.xnode.id,_colMatchGroup)<0){jElement.effect("highlight",{color:'#B02222'},1000);return false;}}
var rowMatch=ctx.opts["matchMaxes"][nodeXY.xnode.id]['matchMax'];if(rowMatch==1){$(ctx.qti_item_id+" ."+nodeXY.xnode['class']).each(function(){deactivateNode($(this));});}
else if(rowMatch>1){var rowMatched=$(ctx.qti_item_id+" ."+nodeXY.xnode['class']+".tabActive").length;if(rowMatched>=rowMatch){jElement.effect("highlight",{color:'#B02222'},1000);return false;}}
var colMatch=ctx.opts["matchMaxes"][nodeXY.ynode.id]['matchMax'];if(colMatch==1){$("."+nodeXY.ynode['class']).each(function(){deactivateNode($(this));});}
else if(colMatch>1){var colMatched=$(ctx.qti_item_id+" ."+nodeXY.ynode['class']+".tabActive").length;if(colMatched>=colMatch){jElement.effect("highlight",{color:'#B02222'},1000);return false;}}
jElement.addClass('tabActive');associations.push(jElement.attr('id'));}}};$(ctx.qti_item_id+" .match_node").click(function(){selectNode($(this));});if(ctx.opts["values"]){var values=ctx.opts["values"];if(typeof(values)=='object'){for(i in values){var value=values[i];if(value['0']&&value['1']){var row=value['0'];var col=value['1'];selectNode($(ctx.qti_item_id+" .match_node.xnode_"+row+".ynode_"+col));}}}}};QTIWidget.graphic_gap_match=function(ctx){$(ctx.qti_item_id+' .qti_graphic_gap_match_spotlist li').wrapInner('<div></div>');$(ctx.qti_item_id+" .qti_graphic_gap_match_spotlist li:last").after("<li></li>");$(ctx.qti_item_id+" .qti_graphic_gap_match_spotlist li:last").css('clear','both');var containerHeight=parseInt($(ctx.qti_item_id+' .qti_graphic_gap_match_spotlist li').height());var containerWidth=5;$(ctx.qti_item_id+' .qti_graphic_gap_match_spotlist li').each(function(){containerWidth+=parseInt($(this).width())+4;});$(ctx.qti_item_id+' .qti_graphic_gap_match_spotlist').width(containerWidth).height(containerHeight);$(ctx.qti_item_id+" .qti_graphic_gap_match_spotlist li > div").draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");},containment:ctx.qti_item_id,revert:'valid',cursor:"move"});var imageHeight=parseInt(ctx.opts.imageHeight);var imageWidth=parseInt(ctx.opts.imageWidth);var itemHeight=parseInt($(ctx.qti_item_id).height());$(ctx.qti_item_id).css("height",itemHeight+imageHeight);if(isNaN(imageHeight)||isNaN(imageWidth)){$(ctx.qti_item_id).append("<div class='img-loader' style='visibility:hidden;'></div>");$loadedImg=$("<img src='"+ctx.opts.imagePath+"' />");$loadedImg.load(function(){var imageWidth=parseInt($(this).width());var imageHeight=parseInt($(this).height());$(ctx.qti_item_id+' .img-loader').remove();createArea(imageWidth,imageHeight);});$(ctx.qti_item_id+' .img-loader').append($loadedImg);}
else{createArea(imageWidth,imageHeight);}
function createArea(imageWidth,imageHeight){$(ctx.qti_item_id+' .qti_graphic_gap_match_spotlist').before("<div class='svg-container'></div>");var paper=Raphael($(ctx.qti_item_id+' .svg-container')[0],imageWidth,imageHeight);paper.image(ctx.opts.imagePath,0,0,imageWidth,imageHeight);var shapes={};for(identifier in ctx.opts.matchMaxes){if(ctx.opts.matchMaxes[identifier]['shape']&&ctx.opts.matchMaxes[identifier]['coords']){var coords=ctx.opts.matchMaxes[identifier]['coords'].split(',');switch(ctx.opts.matchMaxes[identifier]['shape']){case'circle':shapes[identifier]=paper.circle(Number(coords[0]),Number(coords[1]),Number(coords[2]));break;case'rect':shapes[identifier]=paper.rect(Number(coords[0]),Number(coords[1]),Number(coords[2])-Number(coords[0]),Number(coords[3])-Number(coords[1]));break;case'ellipse':shapes[identifier]=paper.ellipse(Number(coords[0]),Number(coords[1]),Number(coords[2]),Number(coords[3]));break;case"poly":shapes[identifier]=paper.path(polyCoordonates(ctx.opts.matchMaxes[identifier]["coords"]));break;}
shapes[identifier].attr({"stroke-opacity":"0","stroke-width":"0","fill-opacity":"0"});shapes[identifier].toFront();if(ctx.graphicDebug){shapes[identifier].attr({"stroke-width":"3px","stroke-opacity":"1","stroke":"blue"});}
shapes[identifier].id=identifier;}}
var detectMouseCollision=function(event,params){return raphaelcollision(params.raphShape,params.collisables,event.pageX-((params.offsetLeft)?params.offsetLeft:0),event.pageY-((params.offsetTop)?params.offsetTop:0));};var collisables=[];for(i in shapes){collisables.push(shapes[i]);}
var offset=$(ctx.qti_item_id+' .svg-container').offset();var collisionContext={raphShape:paper,collisables:collisables,offsetLeft:offset.left,offsetTop:offset.top};$(ctx.qti_item_id+' .svg-container').droppable({accept:ctx.qti_item_id+" .qti_graphic_gap_match_spotlist li > div",drop:function(event,ui){var draggedId=$(ui.draggable).parent().attr("id");var result=detectMouseCollision(event,collisionContext);if(result.length>0){fillGap($(this),$(ui.draggable),result[0][2].id,result[0][2]);}}});}
var fillGap=function(jDropped,jDragged,gapId,raphShape){var draggedId=jDragged.parent().attr("id");var filledId='gap_'+gapId+'_'+draggedId;if($(ctx.qti_item_id+' #'+filledId).length>0){return false;}
var _matchGroup=ctx.opts["matchMaxes"][draggedId]["matchGroup"];if(_matchGroup.length>0){if($.inArray(gapId,_matchGroup)<0){raphShape.animate({"fill-opacity":1,"fill":'red'},500);setTimeout(function(){raphShape.animate({"fill-opacity":0},400);},500);return false;}}
var _gapMatchGroup=ctx.opts["matchMaxes"][gapId]["matchGroup"];if(_gapMatchGroup.length>0){if($.inArray(draggedId,_gapMatchGroup)<0){raphShape.animate({"fill-opacity":1,"fill":'red'},500);setTimeout(function(){raphShape.animate({"fill-opacity":0},400);},500);return false;}}
var _matchMax=Number(ctx.opts["matchMaxes"][draggedId]["matchMax"]);var _current=Number(ctx.opts["matchMaxes"][draggedId]["current"]);if(_current<_matchMax){_current++;ctx.opts["matchMaxes"][draggedId]["current"]=_current;}
if(_current>=_matchMax){jDragged.hide();}
jDropped.append("<div id='"+filledId+"' class='filled_gap'>"+jDragged.html()+"</span>");$(ctx.qti_item_id+' #'+filledId).css({'top':raphShape.attrs.y,'left':raphShape.attrs.x});$(ctx.qti_item_id+' #'+filledId).draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");},stop:function(){removeFilledGap($(this));},revert:false,containment:ctx.qti_item_id,cursor:"move"});};var removeFilledGap=function(jElement){var filledId=jElement.attr("id").replace('gap_','').split('_');var draggedId=filledId[1];var _matchMax=Number(ctx.opts["matchMaxes"][draggedId]["matchMax"]);var _current=Number(ctx.opts["matchMaxes"][draggedId]["current"]);if(_current>0){ctx.opts["matchMaxes"][draggedId]["current"]=_current-1;}
jElement.remove();if(_current>=_matchMax){$(ctx.qti_item_id+' #'+draggedId+" div").show();}};};
var QTIWidget=QTIWidget||{};QTIWidget.order=function(ctx){if(ctx.opts["values"]){var values=ctx.opts["values"];if(typeof(values)=='object'){var list=new Array();for(i in values){var value=values[i];if(typeof(value)=='string'&&value!=''){list.push($(ctx.qti_item_id+" ul.qti_choice_list li#"+value));}}
if(list.length==$(ctx.qti_item_id+" ul.qti_choice_list li").length&&list.length>0){$(ctx.qti_item_id+" ul.qti_choice_list").empty();for(i in list){$(ctx.qti_item_id+" ul.qti_choice_list").append(list[i]);}}}}
var suffixe="";if(ctx.opts.orientation=="horizontal"){$(ctx.qti_item_id+" .qti_choice_list").removeClass("qti_choice_list").addClass("qti_choice_list_horizontal");var sortableOptions={placeholder:'sort-placeholder',axis:'x',containment:ctx.qti_item_id,tolerance:'pointer',forcePlaceholderSize:true,opacity:0.8,start:function(event,ui){$(ctx.qti_item_id+" .sort-placeholder").width($("#"+ui.helper[0].id).width()+4);$(ctx.qti_item_id+" .sort-placeholder").height($("#"+ui.helper[0].id).height()+4);$("#"+ui.helper[0].id).css("top","-4px");},beforeStop:function(event,ui){$("#"+ui.helper[0].id).css("top","0");}};suffixe="_horizontal";}else{var sortableOptions={placeholder:'sort-placeholder',axis:'y',containment:ctx.qti_item_id,tolerance:'pointer',forcePlaceholderSize:true,opacity:0.8,start:function(event,ui){$(ctx.qti_item_id+" .sort-placeholder").width($("#"+ui.helper[0].id).width()+4);$(ctx.qti_item_id+" .sort-placeholder").height($("#"+ui.helper[0].id).height()+4);$("#"+ui.helper[0].id).css("top","-4px");},beforeStop:function(event,ui){$("#"+ui.helper[0].id).css("top","0");}};}
if(ctx.opts.orientation=="horizontal"){$(ctx.qti_item_id).append("<div class='sizeEvaluator'></div>");$(ctx.qti_item_id+" .sizeEvaluator").css("font-size",$(ctx.qti_item_id+" .qti_choice_list_horizontal li").css("font-size"));var containerWidth=0;$(ctx.qti_item_id+" .qti_choice_list_horizontal li").each(function(){$(ctx.qti_item_id+" .sizeEvaluator").text($(this).text());var liSize=$(ctx.qti_item_id+" .sizeEvaluator").width();var liChildren=$(this).children();if(liChildren.length>0){$.each(liChildren,function(index,elt){liSize+=$(elt).width();});}
$(this).width(liSize+10);containerWidth+=liSize+20;});if(parseInt($(ctx.qti_item_id).width())<containerWidth){$(ctx.qti_item_id).width(containerWidth+'px').css({'overflow-x':'auto'});}
$(ctx.qti_item_id+" .sizeEvaluator").remove();}
$(ctx.qti_item_id+" .qti_choice_list"+suffixe).sortable(sortableOptions);$(ctx.qti_item_id+" .qti_choice_list"+suffixe).disableSelection();$(ctx.qti_item_id).append("<div class='breaker'> </div>");};QTIWidget.graphic_order=function(ctx){var list=new Array();if(ctx.opts["values"]){var values=ctx.opts["values"];var list=new Array(values.length);if(typeof(values)=='object'){for(index in values){var value=values[index];var index=parseInt(index);if(typeof(value)=='string'&&value!=''){list[index+1]=value;}}}}
var maxChoices;if(ctx.opts["maxChoices"]==undefined){maxChoices=$(ctx.qti_item_id+" .qti_graphic_order_spotlist li").length;}else{maxChoices=ctx.opts["maxChoices"];}
var countChoices=0;var displayCounter=1;var imageHeight=parseInt(ctx.opts.imageHeight);var imageWidth=parseInt(ctx.opts.imageWidth);var choice_obj=new Object();var shapes=new Object();$(ctx.qti_item_id+" .qti_graphic_order_spotlist li").css("display","none");var itemHeight=parseInt($(ctx.qti_item_id).height());$(ctx.qti_item_id).css("height",itemHeight+imageHeight);if(isNaN(imageHeight)||isNaN(imageWidth)){$(ctx.qti_item_id).append("<div class='img-loader' style='visibility:hidden;'></div>");$loadedImg=$("<img src='"+ctx.opts.imagePath+"' />");$loadedImg.load(function(){var imageWidth=parseInt($(this).width());var imageHeight=parseInt($(this).height());$(ctx.qti_item_id+' .img-loader').remove();createArea(imageWidth,imageHeight);});$(ctx.qti_item_id+' .img-loader').append($loadedImg);}
else{createArea(imageWidth,imageHeight);}
function createArea(imageWidth,imageHeight){$(ctx.qti_item_id).append("<div class='svg-container'></div>");var paper=Raphael($(ctx.qti_item_id+' .svg-container')[0],imageWidth,imageHeight);paper.image(ctx.opts.imagePath,0,0,imageWidth,imageHeight);var state_obj=new Object();$(ctx.qti_item_id).append("<ul class='pickup_area'></ul>");for(var a=1;a<=maxChoices;a++){$(ctx.qti_item_id+" .pickup_area").append("<li class='choice"+a+"'>"+a+"</li>");choice_obj["choice"+a]={selected:"none"};}
$(ctx.qti_item_id+" .pickup_area li").each(function(e){$(this).bind("click",function(e){$(ctx.qti_item_id+" .pickup_area li").removeClass("selected");$(this).addClass("selected");});});$(ctx.qti_item_id+" .pickup_area").width(imageWidth-10-4);var pickup_area_height=parseInt($(ctx.qti_item_id+" .pickup_area").height());$(ctx.qti_item_id).css("height",itemHeight+imageHeight+pickup_area_height+20);$(ctx.qti_item_id).height(parseInt($(ctx.qti_item_id).height())+pickup_area_height);$(ctx.qti_item_id+" .qti_graphic_order_spotlist li").each(function(){var currentHotSpotShape=ctx.opts.graphicOrderChoices[$(this).attr("id")]["shape"];var currentHotSpotCoords=ctx.opts.graphicOrderChoices[$(this).attr("id")]["coords"].split(",");switch(currentHotSpotShape){case"circle":var currentHotSpotX=Number(currentHotSpotCoords[0]);var currentHotSpotY=Number(currentHotSpotCoords[1]);var currentHotSpotSize=currentHotSpotCoords[2];var currentShape=paper[currentHotSpotShape](currentHotSpotX,currentHotSpotY,currentHotSpotSize);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");break;case"rect":var currentHotSpotTopX=Number(currentHotSpotCoords[0]);var currentHotSpotTopY=Number(currentHotSpotCoords[1]);var currentHotSpotBottomX=currentHotSpotCoords[2]-currentHotSpotTopX;var currentHotSpotBottomY=currentHotSpotCoords[3]-currentHotSpotTopY;var currentShape=paper[currentHotSpotShape](currentHotSpotTopX,currentHotSpotTopY,currentHotSpotBottomX,currentHotSpotBottomY);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");break;case"ellipse":var currentHotSpotX=Number(currentHotSpotCoords[0]);var currentHotSpotY=Number(currentHotSpotCoords[1]);var currentHotSpotHradius=currentHotSpotCoords[2];var currentHotSpotVradius=currentHotSpotCoords[3];var currentShape=paper[currentHotSpotShape](currentHotSpotX,currentHotSpotY,currentHotSpotHradius,currentHotSpotVradius);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");break;case"poly":var polyCoords=polyCoordonates(ctx.opts.graphicOrderChoices[$(this).attr("id")]["coords"]);var currentShape=paper["path"](polyCoords);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");break;}
shapes[$(this).attr("id")]=currentShape;currentShape.toFront();currentShape.attr("fill","pink");currentShape.attr("fill-opacity","0");currentShape.attr("stroke-opacity","0");state_obj[$(this).attr("id")]={state:"empty",order:0,numberIn:null,numberOut:null,choiceItemRef:null};if(ctx.graphicDebug)currentShape.attr("stroke-opacity","1");currentShape.attr("stroke","blue");ctx.opts[currentShape.node]=$(this).attr("id");$(currentShape.node).bind("mousedown",{zis:currentShape,name:$(this).attr("id")},function(e){var elementSelected=$(ctx.qti_item_id+" .pickup_area li.selected").length;var displayCounter=parseInt($(ctx.qti_item_id+" .pickup_area li.selected").text());if(state_obj[e.data.name].state=="empty"&&elementSelected==0)return;if(state_obj[e.data.name].state=="empty"&&elementSelected==1){state_obj[e.data.name].state="filled";state_obj[e.data.name].order=displayCounter;var shapeCoordonatesWidth=e.data.zis.getBBox().width;var shapeCoordonatesHeight=e.data.zis.getBBox().height;var shapeCoordonatesX=e.data.zis.getBBox().x+(shapeCoordonatesWidth/2);var shapeCoordonatesY=e.data.zis.getBBox().y+(shapeCoordonatesHeight/2);var orderInfo=paper.text(shapeCoordonatesX,shapeCoordonatesY,$(ctx.qti_item_id+" .pickup_area li.selected").text());var orderInfo1=paper.text(shapeCoordonatesX,shapeCoordonatesY,$(ctx.qti_item_id+" .pickup_area li.selected").text());state_obj[e.data.name].numberIn=orderInfo;state_obj[e.data.name].numberOut=orderInfo1;state_obj[e.data.name].choiceItemRef=$(ctx.qti_item_id+" .pickup_area li.selected");orderInfo.attr("font-family","verdana");orderInfo.attr("font-size",16);orderInfo.attr("font-weight","bold");orderInfo.attr("fill","#009933");orderInfo.attr("stroke","#009933");orderInfo.attr("stroke-width","3px");orderInfo1.attr("font-family","verdana");orderInfo1.attr("font-size",16);orderInfo1.attr("font-weight","bold");orderInfo1.attr("fill","#ffffff");currentShape.toFront();$(ctx.qti_item_id+" .pickup_area li.selected").css("visibility","hidden");$(ctx.qti_item_id+" .pickup_area li.selected").removeClass("selected");}else{state_obj[e.data.name].numberIn.remove();state_obj[e.data.name].numberOut.remove();state_obj[e.data.name].state="empty";state_obj[e.data.name].choiceItemRef.css("visibility","visible");}
$(ctx.qti_item_id).data('order',state_obj);});});}
for(var index=0;index<list.length;index++){var identifier=list[index];if(identifier!=undefined){var choice=$(ctx.qti_item_id+" .pickup_area li.choice"+index).addClass('selected');var shape=shapes[identifier];$(shape.node).trigger("mousedown",{zis:shape,name:identifier,raphElement:shape});}}};
var QTIWidget=QTIWidget||{};QTIWidget.hottext=function(ctx){var maxChoices=(ctx.opts['maxChoices'])?parseInt(ctx.opts['maxChoices']):1;$(ctx.qti_item_id+" .hottext_choice").click(function(){if(maxChoices==0){$(this).toggleClass('hottext_choice_on').toggleClass('hottext_choice_off');}
if(maxChoices==1){if($(ctx.qti_item_id+" .hottext_choice").length==1){$(this).toggleClass('hottext_choice_on').toggleClass('hottext_choice_off');}
else{$(ctx.qti_item_id+" .hottext_choice").removeClass('hottext_choice_on').addClass('hottext_choice_off');$(this).removeClass('hottext_choice_off').addClass('hottext_choice_on');}}
if(maxChoices>1){if($(ctx.qti_item_id+" .hottext_choice_on").length<maxChoices||$(this).hasClass('hottext_choice_on')){$(this).toggleClass('hottext_choice_on').toggleClass('hottext_choice_off');}}});if(ctx.opts["values"]){var values=ctx.opts["values"];if(typeof(values)=='string'&&values!=''){$(ctx.qti_item_id+" #hottext_choice_"+values).switchClass('hottext_choice_off','hottext_choice_on');}
if(typeof(values)=='object'){for(i in values){var value=values[i];if(typeof(value)=='string'&&value!=''){$(ctx.qti_item_id+" #hottext_choice_"+value).switchClass('hottext_choice_off','hottext_choice_on');}}}}};QTIWidget.hotspot=function(ctx){var currentValues=[];if(ctx.opts["values"]){var values=ctx.opts["values"];if(typeof(values)=='object'){for(i in values){currentValues.push(values[i]);}}
if(typeof(values)=='string'){currentValues.push(values);}}
var maxChoices=ctx.opts["maxChoices"];var countChoices=0;var imageHeight=parseInt(ctx.opts["imageHeight"]);var imageWidth=parseInt(ctx.opts["imageWidth"]);$(ctx.qti_item_id+" .qti_hotspot_spotlist li").css("display","none");var itemHeight=parseInt($(ctx.qti_item_id).height());$(ctx.qti_item_id).css("height",itemHeight+imageHeight);if(isNaN(imageHeight)||isNaN(imageWidth)){$(ctx.qti_item_id).append("<div class='img-loader' style='visibility:hidden;'></div>");$loadedImg=$("<img src='"+ctx.opts.imagePath+"' />");$loadedImg.load(function(){var imageWidth=parseInt($(this).width());var imageHeight=parseInt($(this).height());$(ctx.qti_item_id+' .img-loader').remove();createArea(imageWidth,imageHeight);});$(ctx.qti_item_id+' .img-loader').append($loadedImg);}
else{createArea(imageWidth,imageHeight);}
function createArea(imageWidth,imageHeight){$(ctx.qti_item_id).append("<div class='svg-container'></div>");var paper=Raphael($(ctx.qti_item_id+' .svg-container')[0],imageWidth,itemHeight+imageHeight);paper.image(ctx.opts.imagePath,0,0,imageWidth,imageHeight);$(ctx.qti_item_id+" .qti_hotspot_spotlist li").each(function(){var currentHotSpotShape=ctx.opts.hotspotChoice[$(this).attr("id")]["shape"];var currentHotSpotCoords=ctx.opts.hotspotChoice[$(this).attr("id")]["coords"].split(",");switch(currentHotSpotShape){case"circle":var currentHotSpotX=Number(currentHotSpotCoords[0]);var currentHotSpotY=Number(currentHotSpotCoords[1]);var currentHotSpotSize=currentHotSpotCoords[2];var currentShape=paper[currentHotSpotShape](currentHotSpotX,currentHotSpotY,currentHotSpotSize);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");var shapeWidth=currentShape.getBBox().width;var shapeHeight=currentShape.getBBox().height;var pointerWidth=10;var pointerHeight=10;var pointer=paper.image(ctx.wwwPath+"img/cross.png",currentHotSpotX-(pointerWidth/2),currentHotSpotY-(pointerHeight/2),pointerWidth,pointerHeight);break;case"rect":var currentHotSpotTopX=Number(currentHotSpotCoords[0]);var currentHotSpotTopY=Number(currentHotSpotCoords[1]);var currentHotSpotBottomX=currentHotSpotCoords[2]-currentHotSpotTopX;var currentHotSpotBottomY=currentHotSpotCoords[3]-currentHotSpotTopY;var currentShape=paper[currentHotSpotShape](currentHotSpotTopX,currentHotSpotTopY,currentHotSpotBottomX,currentHotSpotBottomY);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");var shapeWidth=currentShape.getBBox().width;var shapeHeight=currentShape.getBBox().height;var pointerWidth=10;var pointerHeight=10;var pointer=paper.image(ctx.wwwPath+"img/cross.png",currentHotSpotTopX+(shapeWidth/2)-(pointerWidth/2),currentHotSpotTopY+(shapeHeight/2)-(pointerHeight/2),pointerWidth,pointerHeight);break;case"ellipse":var currentHotSpotX=Number(currentHotSpotCoords[0]);var currentHotSpotY=Number(currentHotSpotCoords[1]);var currentHotSpotHradius=currentHotSpotCoords[2];var currentHotSpotVradius=currentHotSpotCoords[3];var currentShape=paper[currentHotSpotShape](currentHotSpotX,currentHotSpotY,currentHotSpotHradius,currentHotSpotVradius);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");var pointerWidth=10;var pointerHeight=10;var pointer=paper.image(ctx.wwwPath+"img/cross.png",currentHotSpotX-(pointerWidth/2),currentHotSpotY-(pointerHeight/2),pointerWidth,pointerHeight);break;case"poly":var polyCoords=polyCoordonates(ctx.opts.hotspotChoice[$(this).attr("id")]["coords"]);var currentShape=paper["path"](polyCoords);if(ctx.graphicDebug)currentShape.attr("stroke-width","3px");var shapeWidth=currentShape.getBBox().width;var shapeHeight=currentShape.getBBox().height;var pointerCoordonates=pointerPolyCoordonates(ctx.opts.hotspotChoice[$(this).attr("id")]["coords"]);var currentHotSpotTopX=Number(pointerCoordonates[0]);var currentHotSpotTopY=Number(pointerCoordonates[1]);var pointerWidth=10;var pointerHeight=10;var pointer=paper.image(ctx.wwwPath+"img/cross.png",currentHotSpotTopX+(shapeWidth/2)-(pointerWidth/2),currentHotSpotTopY+(shapeHeight/2)-(pointerHeight/2),pointerWidth,pointerHeight);break;}
pointer.attr("opacity","0");currentShape.toFront();currentShape.attr("fill","pink");currentShape.attr("fill-opacity","0");currentShape.attr("stroke-opacity","0");if(ctx.graphicDebug)currentShape.attr("stroke-opacity","1");currentShape.attr("stroke","blue");ctx.opts[currentShape.node]=$(this).attr("id");$(currentShape.node).bind("mousedown",{zis:currentShape,name:$(this).attr("id"),raphElement:currentShape},function(e){var node=$(ctx.qti_item_id+" #"+e.data.name);if(node.hasClass('activated')){countChoices-=1;pointer.attr("opacity","0");node.removeClass('activated');}
else{if(countChoices>=maxChoices){return;}
countChoices+=1;pointer.attr("opacity","1");paper.safari();node.addClass('activated');}});if($.inArray($(this).attr("id"),currentValues)>-1){$(currentShape.node).trigger("mousedown",{zis:currentShape,name:$(this).attr("id"),raphElement:currentShape});}});}};QTIWidget.select_point=function(ctx){var maxChoices=ctx.opts["maxChoices"];var countChoices=0;var imageHeight=parseInt(ctx.opts.imageHeight);var imageWidth=parseInt(ctx.opts.imageWidth);var itemHeight=parseInt($(ctx.qti_item_id).height());$(ctx.qti_item_id).css("height",itemHeight+imageHeight);$(ctx.qti_item_id+" .qti_select_point_interaction_container").css({"background":"url("+ctx.opts.imagePath+") no-repeat"}).width(imageWidth+'px').height(imageHeight+'px');function setPoint(jContainer,x,y){if(countChoices>=maxChoices&&maxChoices!=0){return;}
countChoices++;var offset=jContainer.offset();jContainer.append("<img src='"+ctx.wwwPath+"img/cross.png' alt='cross' class='select_point_cross' />").find("img:last").css({position:"absolute",top:y+'px',left:x+'px',"cursor":"pointer"}).data('coords',parseInt(x-offset.left)+','+parseInt(y-offset.top)).bind("click",function(e){countChoices--;$(this).remove();return false;});}
var containerArea=$(ctx.qti_item_id+" .qti_select_point_interaction_container");if(ctx.opts["values"]){var values=ctx.opts["values"];if(typeof(values)=='object'){for(i in values){var value=values[i];if(typeof(value)=='object'){if(value['0']&&value['1']){setPoint(containerArea,containerArea.offset().left+parseInt(value['0']),containerArea.offset().top+parseInt(value['1']));}}}}}
containerArea.bind("click",function(e){var relativeXmouse=e.pageX-5;var relativeYmouse=e.pageY-5;setPoint($(this),relativeXmouse,relativeYmouse);});};
var QTIWidget=QTIWidget||{};QTIWidget.text_entry=function(ctx){if(ctx.opts['expectedLength']){length=parseInt(ctx.opts['expectedLength']);$(ctx.qti_item_id).css('width',(length*10)+'px').attr('maxLength',length);}
QTIWidget.string_interaction(ctx);};QTIWidget.extended_text=function(ctx){if($(ctx.qti_item_id).get(0).nodeName.toLowerCase()=='textarea'){if(ctx.opts['expectedLength']||ctx.opts['expectedLines']){var baseWidth=parseInt($(ctx.qti_item_id).css('width'))|400;var baseHeight=parseInt($(ctx.qti_item_id).css('height'))|100;if(ctx.opts['expectedLength']){var expectedLength=parseInt(ctx.opts['expectedLength']);if(expectedLength>0){var width=expectedLength*10;if(width>baseWidth){var height=(width/baseWidth)*16;if(height>baseHeight){$(ctx.qti_item_id).css('height',height+'px');}}
$(ctx.qti_item_id).attr('maxLength',length);}}
if(ctx.opts['expectedLines']){$(ctx.qti_item_id).css('height',(parseInt(ctx.opts['expectedLines'])*16)+'px');}}
QTIWidget.string_interaction(ctx);}
if($(ctx.qti_item_id).get(0).nodeName.toLowerCase()=='div'){if(ctx.opts['expectedLength']){var expectedLength=parseInt(ctx.opts['expectedLength']);if(expectedLength>0){$(ctx.qti_item_id+" :text").css('width',(expectedLength*10)+'px').attr('maxLength',expectedLength);}}
if(ctx.opts['patternMask']){var pattern=new RegExp("/^"+ctx.opts['patternMask']+"$/");$(ctx.qti_item_id+" :text").change(function(){$(this).removeClass('field-error');if(!pattern.test($(this).val())){$(this).addClass('field-error');}});}
if(ctx.opts["values"]){var values=ctx.opts["values"];if(typeof(values)=='object'){for(i in values){var value=values[i];if(typeof(value)=='string'&&value!=''){$(ctx.qti_item_id+" :text#"+ctx.qti_item_id+"_"+i).val(value);}}}}}};QTIWidget.string_interaction=function(ctx){if(ctx.opts['patternMask']){var pattern=new RegExp("^"+ctx.opts['patternMask']+"$");$(ctx.qti_item_id).change(function(){$(this).removeClass('field-error');if(!pattern.test($(this).val())){$(this).addClass('field-error');}});}
if(ctx.opts['stringIdentifier']){$(ctx.qti_item_id).after("<input type='hidden' id='"+ctx.opts['stringIdentifier']+"' />");$("#"+ctx.opts['stringIdentifier']).addClass('qti_text_entry_interaction');$(ctx.qti_item_id).change(function(){$("#"+ctx.opts['stringIdentifier']).val($(this).val());});}
if(ctx.opts["values"]){var value=ctx.opts["values"];if(typeof(value)=='string'&&value!=''){$(ctx.qti_item_id).val(value);}}};
function QTIResultCollector(options){var _this=this;this.opts=options;this.id=options['id'];this.choice=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxChoices"]!=1)?[]:null};var userData=new Array();$("#"+_this.id+" .tabActive").each(function(){if(_this.opts["maxChoices"]!=1)
result.value.push(this.id);else
result.value=this.id;});return result;};this.order=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":new Object()};var i=0;var listClass=(_this.opts['orientation']=='horizontal')?'qti_choice_list_horizontal':'qti_choice_list';$('#'+_this.id+' ul.'+listClass+' li').each(function(){result.value[i]=this.id;i++;});return result;};this.associate=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxChoices"]!=1)?[]:null};$("#"+_this.id+" .qti_association_pair").each(function(){if(!$(this).find('li:first').find('.filled_pair').length){return;}
var firstId='';if($(this).find('li:first').find('.filled_pair').length>0){firstId=$(this).find('li:first').find('.filled_pair').attr('id').replace('pair_','');}
var lastId='';if($(this).find('li:last').find('.filled_pair').length>0){lastId=$(this).find('li:last').find('.filled_pair').attr('id').replace('pair_','');}
var elt=null;if(_this.opts.responseBaseType=="pair"){elt=[firstId,lastId];}else if(_this.opts.responseBaseType=="directedPair"){elt={0:firstId,1:lastId};}
if(_this.opts["maxChoices"]!=1){result.value.push(elt);}else{result.value=elt;}});return result;};this.text=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":null};if($("#"+_this.id).get(0).nodeName.toLowerCase()!='div'){switch(_this.opts['baseType']){case"integer":result.value=parseInt($("#"+_this.id).val());break;case"float":result.value=parseFloat($("#"+_this.id).val());break;case"string":default:result.value=$("#"+_this.id).val();}}
else{result.value=new Array();$("#"+_this.id+" :text").each(function(){switch(_this.opts['baseType']){case"integer":result.value.push(parseInt($("#"+_this.id).val()));break;case"float":result.value.push(parseFloat($("#"+_this.id).val()));break;case"string":default:result.value.push($("#"+_this.id).val());}});}
return result;};this.text_entry=this.text;this.extended_text=this.text;this.inline_choice=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":$("#"+_this.id).val()};return result;};this.hottext=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxChoices"]!=1)?[]:null};$("#"+_this.id+" .hottext_choice_on").each(function(){if(_this.opts["maxChoices"]!=1)
result.value.push(this.id.replace(/^hottext_choice_/,''));else
result.value=this.id.replace(/^hottext_choice_/,'');});return result;};this.gap_match=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":[]};$("#"+_this.id+" .filled_gap").each(function(){var choiceId=$(this).attr('id').replace('gap_','');var groupId=$(this).parent().attr('id');result.value.push({0:groupId,1:choiceId});});if($.isArray(result.value)&&result.value.length==1){result.value=result.value.shift();}
return result;};this.match=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":[]};$("#"+_this.id+" .tabActive").each(function(){var subset=new Object();var classes=$(this).attr('class').split(' ');if(classes.length>0){var i=0;while(i<classes.length){if(/^xnode_/.test(classes[i])){subset[0]=classes[i].replace('xnode_','');}
if(/^ynode_/.test(classes[i])){subset[1]=classes[i].replace('ynode_','');}
i++;}
result.value.push(subset);}});return result;};this.hotspot=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":[]};$("#"+_this.id+" li.activated").each(function(){if(_this.opts["maxChoices"]!=1)
result.value.push($(this).attr('id'));else
result.value=$(this).attr('id');});return result;};this.select_point=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":[]};$("#"+_this.id+" img.select_point_cross").each(function(){var coords=$(this).data('coords').split(',');if(_this.opts["maxChoices"]!=1)
result.value.push({'0':coords[0],'1':coords[1]});else
result.value={'0':coords[0],'1':coords[1]};});return result;};this.graphic_order=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":new Object()};var orderedElts=$("#"+_this.id).data('order');for(id in orderedElts){var orderedElt=orderedElts[id];if(orderedElt.state!='empty'){result.value[parseInt(orderedElt.order)-1]=id;}}
return result;};this.graphic_associate=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":[]};var pairs=$("#"+_this.id).data('pairs');for(i in pairs){var pair=pairs[i].split(' ');if(pair.length==2){result.value.push(pair);}}
return result;};this.graphic_gap_match=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":[]};$("#"+_this.id+" .filled_gap").each(function(){var filledId=$(this).attr("id").replace('gap_','').split('_');result.value.push({0:filledId[0],1:filledId[1]});});if($.isArray(result.value)&&result.value.length==1){result.value=result.value.shift();}
return result;};this.slider=function(){return{"identifier":_this.opts['responseIdentifier'],"value":parseInt($("#"+_this.id+' #qti_slider_value').val())};};this.upload=function(){var value=0;switch(_this.opts['baseType']){case"float":value=parseFloat($("#"+_this.id+'_data').val());break;case"integer":default:value=parseInt($("#"+_this.id+'_data').val());}
return{"identifier":_this.opts['responseIdentifier'],"value":value};};this.end_attempt=function(){var value=0;if(parseInt($("#"+_this.id+'_data').val())>1){value=1;}
return{"identifier":_this.opts['responseIdentifier'],"value":value};};}
var qti_initParam=new Object();function qti_init(qti_initParam){for(var a in qti_initParam){qti_init_interaction(qti_initParam[a]);}}
function qti_init_interaction(initObj){var myQTIWidgetFactory=new QTIWidgetFactory(initObj);var myResultCollector=new QTIResultCollector(initObj);var typeName=initObj["type"].replace('qti_','').replace('_interaction','');myQTIWidgetFactory.build(typeName);$("#qti_validate").bind("click",function(e){e.preventDefault();$('body').css('cursor','wait');var result=myResultCollector[typeName].apply();if(typeof(matchingSetResponses)=='function'){matchingSetResponses([result]);}});}
$(window).load(function(){var matchingParam=new Object();var responseToId=new Object();var itemIdentifier=$("div.qti_item").attr('id')||'';if(typeof(getRecoveryContext)=='function'){for(serial in qti_initParam){if(qti_initParam[serial]['responseIdentifier']){try{responseToId[qti_initParam[serial]['responseIdentifier']]=itemIdentifier+'_'+qti_initParam[serial]['id'];qti_initParam[serial]['values']=$.parseJSON(getRecoveryContext(responseToId[qti_initParam[serial]['responseIdentifier']]));}catch(parseException){}}}}
qti_init(qti_initParam);$("#qti_validate").bind("click",function(){if(typeof(matchingGetResponses)=='function'&&typeof(setAnsweredValues)=='function'){var responses=matchingGetResponses();var answeredValues=null;var size=0;for(key in responses){if(answeredValues==null){answeredValues=new Object();}
answeredValues[responses[key]['identifier']]=responses[key]['value'];size++;setRecoveryContext(responseToId[responses[key]['identifier']],JSON.stringify(responses[key]['value']));}
if($.isPlainObject(answeredValues)){if(size==1&&answeredValues['RESPONSE']){setAnsweredValues(JSON.stringify(answeredValues['RESPONSE']));}
else{setAnsweredValues(JSON.stringify(answeredValues));}}
matchingEvaluate();}});});